<!DOCTYPE html><html><head>
      <title>diseño_pedales</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h2 id="objetivos">Objetivos </h2>
<p>Estudiar las Características Electroacústicas de la Distorsión</p>
<p>Comparar y Contrastar las características de un pedal de distorsión real con una implementación algorítmica.</p>
<p>Evaluar la viabilidad de la implementación de el efecto de distorsión en un microcontrolador.</p>
<h2 id="descripción">Descripción </h2>
<p>Comenzamos presentando las características electroacústicas de la distorsión. Luego, analizamos la distorsión de forma teórica, evaluando cuales son los cambios que introduce en la señal de entrada y como estos se manifestan en el dominio del tiempo y la frecuencia. Procedemos a utilizar esto como referencia para la implementación de una "distorsión ideal" mediante software. Procedemos a comparar esta implementación con un pedal de distorsión real, el Boss DS-1, y a hipotetizar el sobre el modelado de las características electroacústicas reales de este pedal en un algoritmo de distorsión por software. Una vez diseñado el algoritmo, lo llevamos a la práctica en un board NUCLEO-F103RB y sacamos conclusiones.</p>
<h2 id="características-acústicas-de-la-distorsión">Características Acústicas de la Distorsión </h2>
<p>El efecto de <em><strong>distorsión</strong></em> pretende brindar un sonido agresivo y saturado a la señal de audio. Tiene su orígen en el "crunch", término que refiere a un clipping (distorsión por cruce) liviano producido por la saturación de las válvulas de un amplificador al exigirlo en volúmen. Este efecto auditivo fue aprovechado por guitarristas de rock y blues para obtener un sonido más agresivo que caracterizó el Blues-Rock de los años 50.</p>
<p>Al crunch le sucedio el <em><strong>overdrive</strong></em>, un efecto que busca emular mediante transistores el sonido de un amplificador saturado, permitiendo al usuario enfatizar esta saturación y logrando un sonido aun más agresivo. Este efecto fue esencial en el auge del Rock en los años 60 como género independiente del Blues.</p>
<p>Finalmente, con el advenimiento de la NWOBHM (new wave of british heavy metal) en los años 70, se busco un efecto aún más agresivo, resultando en un pedal que deliberadamente recorta la señal de audio (hard clipping) a fines de lograr sonido agresivo, saturado y con un sustain prolongado, el cual expandió la frontera de lo posible en términos de técnica en guitarra eléctrica (dudosamente estilos como el <em>legatto</em>, <em>sweep picking</em> o <em>tapping</em> serían igualmente atractivos sin la saturación proporcionada por los pedales de distorsión).</p>
<center>
<h4 id="muestra---riff-power-chord">Muestra - Riff Power Chord </h4>
<h4 id="limpio">Limpio </h4>
<audio controls="">
  <source src="iron-clean.wav" type="audio/wav">
  Your browser does not support the audio element.
</audio>
<h4 id="crunch">Crunch </h4>
<audio controls="">
  <source src="iron-crunch.wav" type="audio/wav">
  Your browser does not support the audio element.
</audio>
<h4 id="distorsión">Distorsión </h4>
<audio controls="">
  <source src="iron-dist.wav" type="audio/wav">
  Your browser does not support the audio element.
</audio>
<h4 id="muestra---solo-con-legatto-y-tapping">Muestra - Solo con <em>Legatto</em> y <em>Tapping</em> </h4>
<h4 id="crunch-1">Crunch </h4>
<audio controls="">
  <source src="rr-crunch.wav" type="audio/wav">
  Your browser does not support the audio element.
</audio>
<h4 id="distorsión-1">Distorsión </h4>
<audio controls="">
  <source src="rr-dist.wav" type="audio/wav">
  Your browser does not support the audio element.
</audio>
</center>
<h2 id="parámetros-electroacústicos">Parámetros Electroacústicos </h2>
<p>Desde el punto de vista teórico, si nuestro input fuese un tono, en el dominio del tiempo se observa un recorte deliberado (hard-clipping) de los picos de la onda, de modo que la amplitud se ve limitada y los picos aparecen achatados. En el dominio de la frecuencia, este comportamiento no lineal introduce armónicos adicionales, sobre todo armónicos impares (lo que se condice con el hecho de que estamos llevando a la senoidal a la forma de una cuadrada) y que prevalecen en altas frecuencias (decaen con menor intensidad en <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span>).</p>
<center>
<h4 id="tono-con-hard-clipping">Tono con <em>Hard-Clipping</em> </h4>
<p><img src="image.png" alt="alt text"></p>
</center>
<p>Observando sus características en el dominio de la frecuencia, resulta fácil inferir por qué un "power-chord" suena agradable al oído mientras que acordes complejos tienden a sonar "sucios". Un power chord se compone fundamentalmente de la tónica (fundamental) y la quinta justa. Esta combinación de intervalos produce introduce armónicos adicionales que agregan "grosor" a la señal al tiempo que, al estar todavía relativamente separados, los nuevos armónicos y su intermodulación no generan un alto grado de superposición. El resultado es un sonido más "lleno" que no llega a ser disonante. En cambio, si agregamos terceras o séptimas, estos armónicos empiezan a superponerse y el dominio de la frecuencia se asemeja cada vez más a una banda plana, que constituiría ruido puro. La señal pierde armonía e incorpora disonancia al punto de volverse desagradable.</p>
<center>
<h4 id="muestra---power-chord-vs-acorde-complejo">Muestra - Power Chord vs Acorde Complejo </h4>
<audio controls="">
  <source src="power.wav" type="audio/wav">
  Your browser does not support the audio element.
</audio>
<audio controls="">
<source src="complex.wav" type="audio/wav">
</audio>
</center>
<p>Por otro lado, observando sus características en el dominio del tiempo, resulta facil inferir por qué un pedal de distorsión incrementa el <em>sustain</em> de la señal (esto es, una mayor duración del sonido). En términos de la señal, la parte inicial (ataque) de la nota sufre saturación cuando la amplitud es alta, y, a medida que la amplitud de la onda disminuye, el sistema distorsionador (o saturador) continúa elevando las partes más débiles, prolongando su duración.</p>
<center>
<h4 id="muestra---sustain-con-vs-sin-distorsión">Muestra - Sustain con vs sin Distorsión </h4>
<audio controls="">
  <source src="sustain.wav" type="audio/wav">
  Your browser does not support the audio element.
</audio>
<audio controls="">
<source src="nosustain.wav" type="audio/wav">
</audio>
</center>
<h2 id="implementación-de-una-distorsión-ideal-mediante-software">Implementación de una Distorsión "Ideal" Mediante Software </h2>
<p>Si la esencia del efecto de distorsión es el hard-clipping, y la esencia del hard-clipping es recortar la señal, entonces una implementación algorítmica del efecto de distorsión debería ser muy sencilla. Tanto así que cualquier microcontrolador elemental con un ADC debería poder convertirse en un módulo distorsionador. El objetivo de esta sección es implementar una distorsión "ideal" mediante software a la cual pueda introducirsele una señal limpia y evaluar si efectivamente se comporta (en términos auditivos) como un pedal de distorsión.</p>
<h4 id="algoritmo">Algoritmo </h4>
<p>El algorítmo de distorsión más sencillo posible consiste de definir un umbral fijo para el hard-clipping de modo que se recorte más o menos la señal en función de la amplitud. De esta forma, tenemos un solo "control" que es el nivel de distorsión.</p>
<pre data-role="codeBlock" data-info="py" class="language-python py"><code><span class="token keyword keyword-def">def</span> <span class="token function">apply_basic_distortion</span><span class="token punctuation">(</span>signal<span class="token punctuation">,</span> distortion<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Normalizar la señal para asegurar que esté en el rango [-1, 1].</span>
    signal <span class="token operator">=</span> signal <span class="token operator">/</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Calcular el factor de amplificación (drive).</span>
    drive <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> distortion <span class="token operator">*</span> <span class="token number">10</span> 
    amplified <span class="token operator">=</span> drive <span class="token operator">*</span> signal
    
    <span class="token comment"># Hard-Clipping: recortar la señal a un umbral fijo.</span>
    threshold <span class="token operator">=</span> <span class="token number">0.5</span>
    clipped <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>amplified<span class="token punctuation">,</span> <span class="token operator">-</span>threshold<span class="token punctuation">,</span> threshold<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-return">return</span> clipped

</code></pre><h4 id="efecto-sobre-un-tono">Efecto sobre un "Tono" </h4>
<p>El gráfico en el dominio del tiempo evidencia claramente el hard-clipping. Auditivamente, el sonido es similar al de un pedal de distorsión, aunque las limitaciones de la implementación algorítmica se evidencian en que ambas señales pasan a ser indistinguibles a partir de los 5 segundos, indicando que este es precisamente el punto donde la amplitud del tono se reduce tanto que no se está aplicando clipping. De ahí que en el dominio de la frecuencia la diferencia no sea notable más allá de la presencia de varios armónicos en altas frecuencias que no están presentes en la señal limpia.</p>
<center>
<p><img src="image-12.png" alt="alt text"><br>
<img src="image-13.png" alt="alt text"></p>
<audio controls="">
  <source src="tone-clean.wav" type="audio/wav">
</audio>
<audio controls="">
<source src="tone-bd.wav" type="audio/wav">
</audio>
</center>
<h4 id="efecto-sobre-un-riff">Efecto Sobre un Riff </h4>
<p>Como se oye, el audio obtenido es en esencia similar a lo que obtendríamos a partir de un pedal de distorsión, aunque claramente puede detectarse cierta artificialidad en el sonido que delata la implementación algorítmica.</p>
<center>
<p><img src="image-14.png" alt="alt text"><br>
<img src="image-15.png" alt="alt text"></p>
<audio controls="">
  <source src="wp-clean.wav" type="audio/wav">
</audio>
<audio controls="">
<source src="wp-bd.wav" type="audio/wav">
</audio>
</center>
<h2 id="comparación-con-un-pedal-de-distorsión-real-boss-ds-1">Comparación con un Pedal de Distorsión Real (Boss DS-1) </h2>
<p>Como ejemplo de un pedal de distorsión sencillo pero altamente utilizado podemos tomar el Boss DS-1. El circuito del mismo es relativamente simple, tanto así que podemos hacer un breve análisis de su operación y sacar conclusiones respecto a las características electroacústicas del mismo, utilizandolo como referencia para mejorar nuestro algorítmo.</p>
<center>
<p><img src="image-5.png" alt="alt text"><br>
<img src="image-2.png" alt="alt text"></p>
</center>
<ul>
<li><strong><font color="red">Input Buffer</font></strong>: Adaptador de impedancia implementado con BJT en configuración colector común (seguidor emisor) que busca evitar pérdidas de la señal de audio proveniente de la guitarra eléctrica.</li>
<li><strong><font color="green">Booster</font></strong>: Involucra por un lado la amplificación de la señal de la guitarra mediante un BJT en configuración emisor común y por otro una ecualización básica por medio de dos filtros R-C pasa altos consecutivos. Auditivamente, tenemos una señal que sigue siendo limpia (clean), pero ahora suena más fuerte y "brillante" (bright). Omitir esta etapa volvería el tono a la salida uno excesivamente "opaco" y "sucio" (muddy) al amplificar y multiplicar el clipping los armónicos graves de la señal.</li>
<li><strong><font color="darkblue">Etapa de Ganancia</font></strong>: Consiste de dos OP-AMPs no-inversores en cascada cuya ganancia viene dada por el grado de realimentación en el segundo OP-AMP. Como se ve, este es un simple potenciómetro. A la salida, vemos los diodos que introducen el clipping simétrico. Esta claro que este clípping es una función de la ganancia (a mayor amplitud, una proporción mayor de la señal es recortada), de ahí que el potenciómetro que regula la realimentación sea precisamente el control de distorsión en el Boss DS-1.</li>
<li><strong><font color="darkorange">Control de Tono</font></strong>: Consiste de un filtro pasa-bajos y otro pasa-altos, ambos RC, "puenteados" por un potenciómetro que regula la cantidad de señal que pasa por cada filtro. En un extremo, casi toda la señal pasa por el filtro pasa-altos, mientras que en el otro casi toda la señal pasa por el filtro pasa-bajos. En el medio se obtiene un filtro tipo "Notch" alrededor de los 500Hz. Este potenciómetro es el control de tono del Boss DS-1. A la salida hay otro potenciómetro que actúa como control de nivel (divisor resistivo regulable).<br>
<img src="image-8.png" alt="alt text"></li>
<li><strong><font color="purple">Output Buffer</font></strong>: Mismo circuito que el input buffer con el mismo objetivo de adaptar impedancias, en este caso de el pedal a la entrada de un amplificador.</li>
</ul>
<p>A continuación, se muestra el sonido y la forma en el dominio del tiempo y frecuencia de el BOSS-DS1, basado en el modelo del mismo disponible en el software Guitar Rig 5. Como se nota, el sonido es bastante más fideligno al de un pedal de distorsión real que la simple implementación algorítmica.</p>
<h4 id="efecto-sobre-un-tono-1">Efecto sobre un "Tono" </h4>
<center>
<p><img src="image-18.png" alt="alt text"><br>
<img src="image-17.png" alt="alt text"></p>
<audio controls="">
  <source src="tone-ds1.wav" type="audio/wav">
</audio>
</center>
<h4 id="efecto-sobre-un-riff-1">Efecto sobre un "Riff" </h4>
<center>
<p><img src="image-19.png" alt="alt text"></p>
<audio controls="">
  <source src="wp-ds1.wav" type="audio/wav">
</audio>
</center>
<h2 id="implementación-en-un-microcontrolador">Implementación en un Microcontrolador </h2>
<h4 id="mejoras-en-la-implementación-por-software">Mejoras en la Implementación por Software </h4>
<p>Aunque tratar de replicar todo el circuito resultaría impráctico, al tiempo que imposible dadas las limitaciones de hardware de un microcontrolador, sí podemos utilizar el estudio previo como referencia para introducir mejoras en nuestro algoritmo de distorsión. Vemos que un pedal de distorsión presenta como mínimo 3 controles:</p>
<ul>
<li><em><strong>Distorsión</strong></em>: Grado de clipping de la señal.</li>
<li><em><strong>Tono</strong></em>: Grado de énfasis de frecuencias altas.</li>
<li><em><strong>Nivel</strong></em>: Volumen de la señal de salida.</li>
</ul>
<p>Tanto el control de nivel como el clipping son triviales de implementar en software bajo cualquier contexto. El control de tono, en cambio, es un poco más complicado. Si bién python dispone de bibliotecas como scipy signal que nos permiten usar filtros, estas no son funcionalidades que vamos a tener a nuestra disponibilidad en un microcontrolador. Esto sumado a las limitaciones propias del dispositivo nos lleva a optar por usar filtros IIR de primer orden que se puede implementar mediante una ecuación recursiva sencilla.</p>
<h4 id="dispositivo-a-utilizar">Dispositivo a Utilizar </h4>
<p>Para la implementación del algoritmo de distorsión por software, elegimos la NUCLEO-F103RB. Esta placa cuenta con un microcontrolador STM32F103RB, el cual tiene un ADC de 12 bits y permite muestrear comodamente a 16kHz. En realidad, el motivo de elegir esta placa es que es la que tenemos a mano, siendo la que se utiliza en la materia Sistemas Embebidos de la facultad. Ciertamente, hay microcontroladores más económicos que pueden muestrear con la misma frecuencia y resolución, pero este es el que tenemos a mano.</p>
<center>
<p><img src="image-22.png" alt="alt text"></p>
</center>
<h4 id="etapa-preamplificadora">Etapa Preamplificadora </h4>
<p>Ordinariamente, la señal de una guitarra eléctrica no excede un <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>p</mi><mi>p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{pp}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">pp</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> de <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>V</mi></mrow><annotation encoding="application/x-tex">1V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">1</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>. Esto es, si conectasemos la guitarra directamente a un osciloscopio la señal estaría centrada en <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mi>N</mi><mi>D</mi></mrow><annotation encoding="application/x-tex">GND</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">GN</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span> y no excedería una amplitud de <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.5</mn><mi>V</mi></mrow><annotation encoding="application/x-tex">0.5V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">0.5</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>. Dado el rango del ADC de <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3.3</mn><mi>V</mi></mrow><annotation encoding="application/x-tex">3.3V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">3.3</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>, se volvió necesario diseñar una etapa preamplificadora que por un lado eleve la señal de la guitarra centrandola en <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.65</mn><mi>V</mi></mrow><annotation encoding="application/x-tex">1.65V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">1.65</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> y al mismo tiempo la amplifique con una ganancia conservadora de entre <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> y <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span>.</p>
<center>
<p><img src="image-25.png" alt="alt text"></p>
</center>
<p>Para esto, el amplificador operacional <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>C</mi><mi>P</mi><mn>6001</mn></mrow><annotation encoding="application/x-tex">MCP6001</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">MCP</span><span class="mord">6001</span></span></span></span> resulto ideal, dado su bajo consumo y alta fidelidad. A continuación, se muestra el esquemático y la implementación. Se observa que estamos utilizando un divisor resistivo para polarizar <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{in}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.65</mn><mi>V</mi></mrow><annotation encoding="application/x-tex">1.65V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">1.65</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> y el amplificador en configuración no inversora con una ganancia <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>v</mi></msub><mo>=</mo><mn>1</mn><mo>+</mo><mfrac><msub><mi>R</mi><mi>f</mi></msub><msub><mi>R</mi><mn>1</mn></msub></mfrac><mo>≈</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">A_v=1+\frac{R_f}{R_1} \approx 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.4365em;vertical-align:-0.4451em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9914em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0077em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5131em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0077em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2901em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>. Los componentes se eligieron en función de su disponibilidad, aunque el alto valor de los resistores es una elección deliberada para limitar la corriente (ya que la nucleo puede proporcionar un máximo de <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>300</mn><mi>m</mi><mi>A</mi></mrow><annotation encoding="application/x-tex">300mA</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">300</span><span class="mord mathnormal">m</span><span class="mord mathnormal">A</span></span></span></span> y <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mn>0</mn></mrow><annotation encoding="application/x-tex">A0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span><span class="mord">0</span></span></span></span> podría no ser el único puerto siendo utilizado).</p>
<center>
<p><img src="image-28.png" alt="alt text"></p>
</center>
<p>Por supuesto, si el objetivo fuese convertir el dispositivo en un pedal de distorsión, sería necesario también diseñar un módulo amplificador para el output del ADC. Sin embargo, nuestro objetivo se circunscribe a evaluar los efectos de la distorsión en la señal de input, de modo que vamos a transmitir el output a la PC por medio de UART, lo que nos permite convertirla en un archivo .wav para su reproducción.</p>
<h4 id="código">Código </h4>
<p>A continuación, se muestra el código utilizado para la implementación del algoritmo de distorsión en la NUCLEO-F103RB.</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-void">void</span> <span class="token function">recordingSendingUpdateDistorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword keyword-uint16_t">uint16_t</span> rawAdcValue <span class="token operator">=</span> micInput<span class="token punctuation">.</span><span class="token function">read_u16</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 12-bit [0..4095]</span>
    <span class="token keyword keyword-int16_t">int16_t</span> sample <span class="token operator">=</span> rawAdcValue <span class="token operator">-</span> <span class="token number">2048</span><span class="token punctuation">;</span>              <span class="token comment">// [-2048..2047]</span>

    <span class="token comment">// Preamplificación</span>
    <span class="token keyword keyword-float">float</span> gain <span class="token operator">=</span> <span class="token number">4.0f</span><span class="token punctuation">;</span>  
    <span class="token keyword keyword-float">float</span> amplified <span class="token operator">=</span> sample <span class="token operator">*</span> gain<span class="token punctuation">;</span>

    <span class="token comment">// Hard clipping</span>
    <span class="token keyword keyword-float">float</span> clipThreshold <span class="token operator">=</span> <span class="token number">400.0f</span><span class="token punctuation">;</span> 
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>amplified <span class="token operator">&gt;</span> clipThreshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        amplified <span class="token operator">=</span> clipThreshold<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>amplified <span class="token operator">&lt;</span> <span class="token operator">-</span>clipThreshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        amplified <span class="token operator">=</span> <span class="token operator">-</span>clipThreshold<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Frecuencia de corte dada por el alpha del filtro IIR de 1er Orden</span>
    <span class="token comment">// Tono ~&gt; 1 = 100% Pasa Altos, 0 = 100% Pasa Bajos</span>
    <span class="token keyword keyword-float">float</span> alpha <span class="token operator">=</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-float">float</span> tone <span class="token operator">=</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>

    <span class="token comment">// Aplicamos los dos filtros</span>
    <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-float">float</span> lpFiltered <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
    lpFiltered <span class="token operator">=</span> alpha <span class="token operator">*</span> amplified <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1.0f</span> <span class="token operator">-</span> alpha<span class="token punctuation">)</span> <span class="token operator">*</span> lpFiltered<span class="token punctuation">;</span>
    <span class="token keyword keyword-float">float</span> hpFiltered <span class="token operator">=</span> amplified <span class="token operator">-</span> lpFiltered<span class="token punctuation">;</span>

    <span class="token comment">// Mezcla</span>
    <span class="token keyword keyword-float">float</span> toneOutput <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0f</span> <span class="token operator">-</span> tone<span class="token punctuation">)</span> <span class="token operator">*</span> lpFiltered <span class="token operator">+</span> <span class="token punctuation">(</span>tone<span class="token punctuation">)</span> <span class="token operator">*</span> hpFiltered<span class="token punctuation">;</span>

    <span class="token comment">// Volvemos a centrar en ~1.65V</span>
    <span class="token keyword keyword-int16_t">int16_t</span> finalSample <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword keyword-int16_t">int16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>toneOutput <span class="token operator">+</span> <span class="token number">2048.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Empaquetamos y enviamos</span>
    <span class="token keyword keyword-char">char</span> data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> finalSample <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>finalSample <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
    uartUsb<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre><p>Algunas observaciones respecto al código:</p>
<ul>
<li>
<p><em><strong>Clipping</strong></em>: Para lograr un efecto auditivo de distorsión se necesitó un umbral bastante chico, por lo que es probable que la amplificación con el MCP6001 fuese muy conservadora, esto es, que la señal de entrada este comodamente por debajo de los <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.5</mn><mi>V</mi><mi>p</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">0.5Vpp</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord">0.5</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">pp</span></span></span></span>, al menos en la mayoría de su excursión.</p>
</li>
<li>
<p><em><strong>Control de Tono</strong></em>: El control de tono se implementó mediante filtros IIR de primer orden. Partimos de un pasa-bajos de ecuación <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo><mo>=</mo><mi>α</mi><mi>x</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>α</mi><mo stretchy="false">)</mo><mi>y</mi><mo stretchy="false">[</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">y[n] = \alpha x[n] + (1-\alpha) y[n-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">αx</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>, donde <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo stretchy="false">[</mo><mi>n</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">x[n]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mclose">]</span></span></span></span> es la señal de entrada, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo stretchy="false">[</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">y[n-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mopen">[</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span> es el output previamente filtrado y <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span> controla el corte del filtro. Para obtener un pasa-altos, restamos el output del pasa-bajos al input (cancelamos el componente de baja frecuencia y preservamos las altas frecuencias). Finalmente, mezclamos ambas señales con un factor de mezcla <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> que controla el grado de énfasis de cada filtro.</p>
</li>
<li>
<p><em><strong>Muestreo y Baudrate</strong></em>: Aunque no se muestra en el código, se opto por muestrear a 8kHz dado que los 16kHz que serían más apropiados para audio involucran un baudrate que excede los <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>230400</mn><mi>b</mi><mi>p</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">230400 bps</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord">230400</span><span class="mord mathnormal">b</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span></span></span></span>. Aunque en teoría este baudrate alto es perfectamente manejable por la NUCLEO-F103RB, se prefirió un valor conservador que garantice la transmisión de la señal sin riesgo de perdida de datos. El análisis del espectro que mostramos arriba indica que el rango de frecuencias de la señal de audio no excede los <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mi>k</mi><mi>H</mi><mi>z</mi></mrow><annotation encoding="application/x-tex">4kHz</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">4</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.04398em;">Hz</span></span></span></span>, por lo que un muestreo a 8kHz es suficiente para capturar la gran mayoría señal sin aliasing.</p>
</li>
</ul>
<h4 id="resultados">Resultados </h4>
<p>A continuación, se comparte una muestra del audio grabado con el algoritmo de distorsión implementado en la NUCLEO-F103RB. Como se oye, el sonido es bastante similar al de un pedal de distorsión real, aunque puede notarse cierta opacidad. Juzgamos que esta se debe principalmente a la limitación de la frecuencia de muestreo y la amplificación conservadora discutidas en el inciso anterior.</p>
<center>
<p><audio controls="" src="output.wav" title="Title"></audio></p>
</center>
<h2 id="conclusiones">Conclusiones </h2>
<p>Auditivamente, una implementación algorítmica de la descripción teórica de la distorsión (boost + hard-clipping) resulta bastante similar a el efecto logrado por un pedal de distorsión real.</p>
<p>En vista de los resultados, concluimos que resulta perfectamente posible implementar un pedal de distorsión mediante software en un microcontrolador que cuente con un ADC.</p>
<p>La viabilidad de la implementación de otros efectos va a depender de la complejidad del algoritmo asociado. La implementación de un efecto de Delay, por ejemplo, resulta bastante intuitiva, siendo un pedal de delay elemental un módulo <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo separator="true">,</mo><mi>α</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(t,\alpha)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span></span></span></span>, siendo <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> el tiempo entre repeticiones y <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span> el factor de atenuación entre cada repetición. Esto sería fácil de llevar a cabo por medio de timers y buffers. En cambio, no resulta para nada intuitiva la implementación de un efecto como el Chorus, el cual implica reproducir la misma señal con una leve variación de tono y fase.</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>